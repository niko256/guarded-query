# guarded-query

Условие :

Создать API для построения SQL-подобных запросов с проверкой типов на этапе компиляции. Определить типы `Query[Select, From, Where]`. Реализовать методы `.select` , `.from` , .where , каждый из которых возвращает новый `Query` с обновленными phantom-типами. Метод `.where` должен быть доступен только после `.from` , а метод `.run` (преобразующий в строку запроса) — только после `.select` . Напишите пример, который компилируется, и пример, который не должен компилироваться , и объясните, как типы обеспечивают эту проверку последовательности.

---

Наш запрос `Query` разбит на несколько логических стадий. Каждая стадия - это состояние построения нашего запроса. Чтобы статически можно было проверять стадии запроса на корректную последоватьельность, сделаем каждую стадию запроса типизированной. Для этого будем использовать [фантомные типы](https://dcapwell.github.io/scala-tour/Phantom%20Type.html). Фантомный параметр типа будет влиять на допустимость операций на этапе компиляции, но не будет использоваться в структуре значения объекта типа.

Каждый фантомный параметр кодирует факт наличия/отсутствия определённой части запроса (кодировка состояния в типе `Query`).

Определим три стадии:

- SELECT : [Phantom type : Selected/NotSelected]
- FROM : [Phantom type : FromSpecified/FromNotSpecified]
- WHERE : [Phantom type : WhereSpecified/WhereNotSpecified]

То есть наш тип `Query` параметризуется тремя фантомными типами:

```Scala
Query[S <: SelectStage, F <: FromStage, W <: WhereStage]
```

где :

- `S` - состояние стадии `SELECT`
- `F` - состояние стаддии `FROM`
- `W` - состояние стадии `WHERE`

если попробовать формализовать, то получится, что если например текущий запрос `q` имеет тип `Query[NotSelected, ...]`, то вызов `.select` возвращает новый запрос типа `Query[Selected, ...]`.

То есть получается вот такое правило типизации :

```
Г |- q : Query[NotSelected, F, W]    Г |- columns : List[String]
-----------------------------------------------------------------
Г |- q : select(columns) : Query[Selected, F, W]
```

# Используемые источники

- Types and Programming Languages (Benjamin C. Pierce, главы : [9, 15])
