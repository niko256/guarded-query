## guarded-query

Условие :

Создать API для построения SQL-подобных запросов с проверкой типов на этапе компиляции. Определить типы `Query[Select, From, Where]`. Реализовать методы `.select` , `.from` , `.where` , каждый из которых возвращает новый `Query` с обновленными phantom-типами. Метод .where должен быть доступен только после `.from` , а метод `.run` (преобразующий в строку запроса) - только после `.select` . Напишите пример, который компилируется, и пример, который не должен компилироваться , и объясните, как типы обеспечивают эту проверку последовательности.

Наш запрос `Query` разбит на несколько логических стадий. Каждая стадия - это состояние построения нашего запроса. ЧТобы статически можно было проверять стадии на корректную последовательностьь, сделаем каждую стадию запроса типизированной. Для этого будем использовать [фантомные типы](https://dcapwell.github.io/scala-tour/Phantom%20Type.html). Фантомный параметр типа будет влиять на допустимость операций на этапе компиляции, но не будет фигурировать в качестве типа в структуре значения.

Каждый фантомный параметр кодирует факт наличия/отсутствия определённой части запроса (кодировка состояния в типе `Query`).

Определим три стадии :

- SELECT : [Phantom type : Selected / NotSelected]
- FROM : [Phantom type : FromSpecified / FromNotSpecified]
- WHERE : [Phantom type : WhereSpecified / WhereNotSpecified]

То есть наш тип `Query` параметризуется тремя фантомными типами :

```Scala
Query[S <: SelectStage, F <: FromStage, W <: WhereStage]
```

где :

- S - состояние стадии `SELECT`
- F - состояние стадии `FROM`
- W - состояние стадии `WHERE`

---

Если попробовать формализовать, то получится, что если например текущий запрос `q` имеет тип `Query[NotSelected, ...]`, то вызов `.select` возвращает новый запрос типа `Query[Selected, ...]`.

То есть например для `select` получается вот такое правило типизации :

```
Г |- q : Query[NotSelected, F, W]    Г |- columns : List[String]
-----------------------------------------------------------------
Г |- q : select(columns) : Query[Selected, F, W]
```

---

для метода `.from` :

```
Г |- q : Query[Selected, FromNotSpecified, W]    Г |- table : String
----------------------------------------------------------------------
Г |- q : from(table) : Query[Selected, FromSpecified, W]
```

---

для `.where` :

```
Г |- q : Query[Selected, FromSpecified, WhereNotSpecified]    Г |- condition : String
---------------------------------------------------------------------------------------
Г |- q : where(condition) : Query[Selected, FromSpecified, WhereSpecified]
```

---

правило для `run` :

```
Г |- q : Query[Selected, F, W]
-------------------------------
Г |- q.run() : String
```

---

## Используемые источники и литература

1. Types and Programming Languages : Benjamin Pierce, главы : [9, 15]
2. Programming in Scala : Мартин Одерски, Лекс Спун, Билл Веннерс, Фрэнк Соммерс [fifth edition, 2022]
